### Makefile for the eclass project
### Generated by Bluespec Workstation on Thu Nov 12 19:54:06 IST 2015

isa_support=RV32IMFD

ifneq (,$(findstring M,$(isa_support)))
  define_macros += -D muldiv=True
endif
ifneq (,$(findstring F,$(isa_support)))
  define_macros += -D spfpu=True
endif
ifneq (,$(findstring D,$(isa_support)))
  define_macros += -D dpfpu=True
endif


default: compile_bluesim link_bluesim

AAPG: check-blue compile_bluesim	link_bluesim	
	@echo "Running Torture Tests now...."
	@cd AAPG;	./make.py

check-blue:
	@if test -z "$$BLUESPECDIR"; then echo "BLUESPECDIR variable not set"; exit 1; fi; 

check-py:
	@if ! [ -a /usr/bin/python3 ] ; then echo "Python3 is required in /usr/bin to run AAPG" ; exit 1; fi;

.PHONY:  compile_bluesim
compile_bluesim:check-blue
	@echo "Compiling mkahb in Bluesim..."
	@mkdir -p BSV_src/build_bsim; 
	bsc -u -sim -simdir BSV_src/build_bsim -bdir BSV_src/build_bsim -info-dir BSV_src/build_bsim -D simulate=True $(define_macros) -keep-fires -opt-undetermined-vals -remove-false-rules -remove-empty-rules -p .:%/Prelude:%/Libraries:%/Libraries/BlueNoC:./BSV_src/CPU_src:./BSV_src/TLM_src:./BSV_src/AHB_src:./BSV_src/FPU_src -g mkahb BSV_src/CPU_src/ahb.bsv
	@echo "Compilation finished"

.PHONY: compile_verilog
compile_verilog:check-blue
	@echo Compiling Testbench_uart in Verilog ...
	@mkdir -p BSV_src/build_bsim; 
	@mkdir -p verilog; 
	bsc -u -verilog -elab -vdir verilog -bdir BSV_src/build_bsim -info-dir BSV_src/build_bsim $(define_macros) -keep-fires -opt-undetermined-vals -remove-empty-rules -remove-false-rules -p .:%/Prelude:%/Libraries:%/Libraries/BlueNoC:./BSV_src/CPU_src:./BSV_src/TLM_src:./BSV_src/AHB_src:./BSV_src/FPU_src -g mkahb BSV_src/CPU_src/ahb.bsv
	@cp ${BLUESPECDIR}/Verilog/SizedFIFO.v ./verilog/
	@cp ${BLUESPECDIR}/Verilog/FIFOL1.v ./verilog/
	@cp ${BLUESPECDIR}/Verilog/RegFileLoad.v ./verilog/
	@cp ${BLUESPECDIR}/Verilog/Counter.v ./verilog/
	@echo Compilation finished

.PHONY: link_bluesim
link_bluesim:check-blue
	@echo "Linking mkahb in Bluesim..."
	@mkdir -p bin
	bsc -e mkahb -sim -o bin/out -parallel-sim-link 4 -simdir BSV_src/build_bsim -D simulate=True -p .:%/Prelude:%/Libraries:%/Libraries/BlueNoC:./BSV_src/CPU_src:./BSV_src/TLM_src:./BSV_src/AHB_src:./BSV_src/FPU_src -bdir BSV_src/build_bsim;
	@echo Linking finished

.PHONY: link_verilog
link_verilog:check-blue
	@echo Linking in Verilog...
	@mkdir -p bin
	@bsc -e mkahb -sim -o bin/out -simdir BSV_src/build_bsim -p .:%/Prelude:%/Libraries:%/Libraries/BlueNoC:./BSV_src/CPU_src:./BSV_src/TLM_src:./BSV_src/AHB_src:./BSV_src/FPU_src -bdir BSV_src/build_bsim
	@echo Linking finished


.PHONY: simulate
simulate:
	@echo Simulation...
	@exec ./bin/out
	@echo Simulation finished

.PHONY: clean
clean:
	rm -rf BSV_src/build_bsim 
	rm -f verilog/*.v

